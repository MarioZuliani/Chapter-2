---
title: "Chapter 2 Carrizo"
output: html_document
---
###Load Data
```{r setup, include=FALSE}
library(ggplot2)
library(tidyverse)
library(dplyr)
library(meta)
library(PRISMAstatement)
library(skimr)
library(MASS)
setwd("/R Packages/Chapter 2")
```

```{r, message=FALSE, warning=TRUE}
###Load all necessary .csv files
setwd("/R Packages/Chapter 2")
photo <- read_csv("Carrizo Shrub Photo density Sheet.csv")
colnames(photo)[6] = "site"
colnames(photo)[11] = "dense.level"
photo$site <- as.character(photo$site)
focal <- read_csv("Focal Observations Data Sheet.csv")
focal$Site <- as.character(focal$Site)
transect <- read_csv("Transect Data Sheet.csv")
transect$Site.Number <- as.character(transect$Site.Number)
cam.location <- read_csv("Camera Location data Sheet.csv")
str(transect)

shrub <- read.csv("Site Data Sheet.csv")
```


### Data Set-up
```{r}
###Give Summary of photo data
summary(photo)
```

```{r}
count.hit <- photo %>%
  count(animal.hit) %>%
  na.omit()
summary(count.hit)

###Camera recorded an animal 2.705% of the time. Not too bad
```
```{r}
skim(photo)
```
```{r}
###Transect Data

summary(transect)
```

```{r}
tran.hit <- transect %>%
  count(animal.hit) %>%
  na.omit()
summary(tran.hit)
```

```{r}
skim(transect)
```
```{r}
tran.hit %>%
  ggplot(aes(animal.hit, n)) + geom_col() + theme_classic() + xlab("Hits") + ylab("Count") + ggtitle("Hits during Transects")
```
```{r}
####Summary capture data on Transects
transect.data <- transect %>%
  group_by(Site, Site.Number, Site.Density) %>%
  summarise(captures = sum(animal.hit), n = n(), animal.richness = n_distinct(RTM)-1) %>% mutate(rate = captures/n) #-1 for richness bc of none as level
transect.data$rate <- as.character(transect.data$rate)

###Summary Transect Animal Data
transect.diversity <- transect %>%
  group_by(Site, Site.Number, Site.Density) %>%
  summarise(captures = sum(animal.hit), n = n()) %>% mutate(rate = captures/n)

unique(transect.diversity$Site.Density)
```
```{r}
transect.level <- transect %>%
  group_by(Site, Site.Number, Site.Density, Date) %>%
  summarise(captures = sum(animal.hit), n = n()) %>% mutate(rate = captures/n)

unique(transect.level$Site.Density)
```

```{r}
###Data Viz for number of hits during photo analysis
count.hit %>%
  ggplot(aes(animal.hit, n)) + geom_col() + theme_classic() + xlab("Hits") + ylab("Count") + ggtitle("Number of total animal hits")
```
```{r}
###Summary Capture Data
data <- photo %>%
  group_by(region, site, week, dense.level, rep, camera.number) %>%
  summarise(captures = sum(animal.hit), n = n(), animal.richness = n_distinct(RTU)-1) %>% mutate(rate = captures/n) #-1 for richness bc of none as level
data$rep <- as.character(data$rep)

###Summary Animal Data
diversity <- photo %>%
  group_by(region, site, dense.level, RTU) %>%
  summarise(captures = sum(animal.hit), n = n()) %>% mutate(rate = captures/n)

unique(diversity$RTU)
```

```{r}
###Summary level Data
level <- photo %>%
  group_by(region, site, week, rep, dense.level) %>%
  summarise(captures = sum(animal.hit), n = n()) %>% mutate(rate = captures/n)

unique(level$dense.level)
```

```{r}
animals <- photo %>%
  group_by(region, site, RTU) %>%
  summarise(captures = sum(animal.hit), n = n()) %>% mutate(rate = captures/n)

unique(animals$RTU)
```

```{r}
summary(shrub)
```

```{r}
###Data for shrub size and total number of shrubs in each site. (Ask Chris about)
shrub.size <- shrub%>%
  group_by(site.number, site.density, shrub.count, x, y, z) %>%
  summarise(volume = sum(x*y*z))
```

```{r}
##Clean up focal data
focal.data <- focal %>%
  count(animal.hit) %>%
  na.omit()

skim(focal)
focal.data <- focal %>%
  group_by(Site, site.density) %>%
  summarise(captures = sum(animal.hit), n = n(), animal.richness = n_distinct(RTU)-1) %>% mutate(rate = captures/n)

unique(transect.level$Site.Density)

focal.site <- focal%>%
  group_by(Site, site.density, Date) %>%
  summarise(captures = sum(animal.hit), n = n(), animal.richness = n_distinct(RTU)-1) %>% mutate(rate = captures/n)
```


###Data Viz
```{r}
###Total captures between site levels

ggplot(level, aes(dense.level, captures)) +
  geom_boxplot() + 
  labs(y = "total captures", x = "site density") + ggtitle("Number of Total Animal Hits in Camera Traps")
```
```{r}
###Capture rate per site level
ggplot(level, aes(dense.level, rate)) +
  geom_boxplot() + 
  labs(y = "capture rate", x = "site density")
```


```{r}
ggplot(transect.level, aes(rate, captures, color = Site.Density)) +
         geom_point() +
  geom_smooth(method = lm, se = FALSE) +
  facet_wrap(~Site.Density, scales = "free") +
  labs(color = "", x = "Rate of Capture", y = "total captures")
```
```{r}
require(mgcv)
ggplot(transect.level, aes(rate, captures, color = Site.Density)) +
         stat_smooth(method = "gam") +
  geom_smooth(method = lm, se = FALSE) +
  facet_wrap(~Site.Density, scales = "free") +
  labs(color = "", x = "Rate of Capture", y = "total captures")
```

```{r}
ggplot(transect.level, aes(n, captures, color = Site.Density)) +
         geom_point() +
  geom_smooth(method = lm, se = FALSE) +
  facet_wrap(~Site.Density, scales = "free") +
  labs(color = "", x = "n", y = "total captures")
```
```{r}
require(mgcv)
ggplot(transect.level, aes(n, captures, color = Site.Density)) +
         stat_smooth(method = "gam") +
  geom_smooth(method = lm, se = FALSE) +
  facet_wrap(~Site.Density, scales = "free") +
  labs(color = "", x = "n", y = "total captures")
```

```{r}
ggplot(transect.level, aes(rate, n, color = Site.Density)) +
         geom_point() +
  geom_smooth(method = lm, se = FALSE) +
  facet_wrap(~Site.Density, scales = "free") +
  labs(color = "", x = "Rate of Capture", y = "n")
```
```{r}
require(mgcv)
ggplot(transect.level, aes(n, rate, color = Site.Density)) +
         stat_smooth(method = "gam") +
  geom_smooth(method = lm, se = FALSE) +
  facet_wrap(~Site.Density, scales = "free") +
  labs(color = "", x = "n", y = "rate")
```

```{r}
###Diversity Plot from Photo Data looking at Total Captures
excludes <- c("none", "None", "unidentifiable", "unkown", "", "Unidentifiable", "Human")

plot.diversity <- diversity%>%
  filter(!RTU %in% excludes)

ggplot(plot.diversity, aes(RTU, captures, fill = site)) +
  geom_bar(stat = "identity") +
  coord_flip() + 
  labs(fill = "", x = "total captures")
```
```{r}
###Diversity Plot from Photo Data looking at Rate
ggplot(plot.diversity, aes(RTU, rate, fill = site)) +
  geom_bar(stat = "identity") +
  coord_flip() + 
  labs(fill = "", x = "total captures")
```
```{r}
ggplot(focal.data, aes(n, captures, color = site.density)) +
         stat_smooth(method = "gam") +
  geom_smooth(method = lm, se = FALSE) +
  facet_wrap(~site.density, scales = "free") +
  labs(color = "", x = "captures", y = "rate")
```
Camera Presence Boxplot
```{r}
ggplot(level, aes(dense.level, captures, fill = as.character(site))) +
  geom_boxplot() +
  labs(y = "Presence", x = "site density")
```
Camera Abundance Boxplot
```{r}
ggplot(level, aes(dense.level, rate, fill = as.character(site))) +
  geom_boxplot() +
  labs(y = "Abundance", x = "site density")
```


Focal Presence Boxplot
```{r}
ggplot(focal.site, aes(site.density, captures, fill = as.character(Site))) +
  geom_boxplot() +
  labs(y = "presence", x = "site density")
```
```{r}

```

###Focal abundance Boxplot
```{r}
ggplot(focal.site, aes(site.density, rate, fill = as.character(Site))) +
  geom_boxplot() +
  labs(y = "abundance", x = "site density")
```


##Stats
###Stats for capture compare to level
```{r}
m <- glm(captures~dense.level, data = level) #capture difference between microsite
summary(m)
```
```{r}
### Test if data is significant
anova(m, test = "Chisq")

####ITS SIGNIFICANT!!!
```
```{r}
shapiro.test(m$residuals)

###Data is not Normally distributed
```
```{r}
library(lsmeans)
lsmeans(m, pairwise~dense.level, adjust = "Tukey")
```
```{r}
m <- glm(captures~dense.level, data = level, family = "quasipoisson")
summary(m)
```


###Stats for Captures by Site
```{r}
m <- glm(captures~site, data = level) #capture difference between microsite
summary(m)
```
```{r}
anova(m, test = "Chisq")
```
```{r}
ggplot(level, aes(dense.level, captures, fill = as.character(site))) +
  geom_boxplot() +
  labs(y = "capture rate", x = "site density")
```

```{r}
m <- glm(rate~site, data = level) #capture difference between microsite
summary(m)
```
```{r}
m <- glm(rate~dense.level, data = level) #rate of capture between microsites
summary(m)
```
```{r}
anova(m, test = "Chisq")
```


```{r}
ggplot(level, aes(dense.level, rate)) +
  geom_boxplot() +
  labs(y = "capture rate", x = "site density")
```


###Stats for rate of capture between Levels
```{r}
mp <- glm(rate~dense.level, data = level, family = "quasipoisson")
summary(mp)
```
```{r}
anova(mp, test = "Chisq")
```
```{r}
shapiro.test(mp$residuals)

###Data is not Normally distributed
```
```{r}
library(lsmeans)
lsmeans(mp, pairwise~dense.level, adjust = "Tukey")
```

###Stats for Transect captures
```{r}
###Boxplot for Transect Captures
ggplot(transect.data,  aes(Site.Density, captures)) +
  geom_boxplot() +
  labs(y = "capture rate", x = "site density")
```

```{r}
mt <- glm(captures~Site.Density, data = transect.level, family = "poisson")
summary(mt)
```
```{r}
anova(mt, test = "Chisq") #get p-value for model
```
```{r}
shapiro.test(mt$residuals) #explore residuals
```
```{r}
library(emmeans)
library(lsmeans)
lsmeans(mt, pairwise~Site.Density, adjust = "Tukey")
```
```{r}
mt <- lm(captures~Site.Number, data = transect.level)
summary(mt)
```


```{r}
mt <- glm(rate~Site.Density, data = transect.level)
summary(mt)
```
```{r}
anova(mt, test = "Chisq")
```
###Look at Stats for varying density level by individual sites for cameras
```{r}
library(emmeans)
mg <- glm(captures~dense.level*as.factor(site), family = "quasipoisson", data = level)
summary(mg)
anova(mg, test = "Chisq")
emmeans(mg, pairwise~dense.level*as.factor(site))
```
regression curve needed!!!!!

###Look at Stats for varying density level by individual sites for Transects
```{r}
library(emmeans)
mt <- glm(captures~Site.Density*as.factor(Site.Number), family = "quasipoisson", data = transect.level)
summary(mt)
anova(mt, test = "Chisq")
emmeans(mt, pairwise~Site.Density*as.factor(Site.Number))
```
###Look at the rate of capture difference between the sites (Cameras)
```{r}
mg <- glm(rate~dense.level*as.factor(site), family = "quasipoisson", data = level)
summary(mg)
anova(mg, test = "Chisq")
emmeans(mg, pairwise~dense.level*as.factor(site))
```
###Looks at the rate of capture between site densities (Transects)
```{r}
mt <- glm(rate~Site.Density*as.factor(Site.Number), family = "quasipoisson", data = transect.level)
summary(mt)
anova(mt, test = "Chisq")
emmeans(mt, pairwise~Site.Density*as.factor(Site.Number))
```


```{r}
mod <- lm(captures~dense.level*as.factor(site), data = level)
summary(mod)
```



```{r}
ggplot(level, aes(rate, captures, color = dense.level)) +
         geom_point() +
  geom_smooth(method = lm, se = FALSE) +
  facet_wrap(~dense.level, scales = "free") +
  labs(color = "", x = "Rate of Capture", y = "captures")
```

```{r}
library(emmeans)
mg <- glm(captures~dense.level*as.factor(site) + offset(log(n)), family = "quasipoisson", data = level)
summary(mg)
anova(mg, test = "Chisq")
emmeans(mg, pairwise~dense.level*as.factor(site))
```



###Interpretation
1) 
##Things still to do
1) Figure out how to do abundance for images
2) Figure out how to do diversity for images
3) Build a species list off what we founf in camera traps



###Diversity Data
```{r}
library(tidyverse)
library(vegan)
photovegan <- photo %>%
  group_by(region, site, rep, dense.level, RTU) %>%
  summarise(captures = sum(animal.hit))

photovegan$region <- gsub(" ", "", photovegan$region)
photovegan$region <- as.factor(photovegan$region)
photovegan$uniID <- paste(photovegan$site, photovegan$dense.level, photovegan$rep)
str(photovegan)
```

```{r}
library(dplyr)
photovegan <- photovegan %>% 
  ungroup()%>%
  dplyr::select(uniID, RTU, captures)
photovegan <- photovegan %>% group_by(uniID, RTU) %>% summarise(captures = sum(captures))

comm <- photovegan %>% spread(RTU, captures) %>% dplyr::select(-none, -None)
comm[is.na(comm)] <- 0
```



```{r}
comm <- comm %>%
  ungroup() %>%
  dplyr::select(-uniID)
```

```{r}
Hphoto <- diversity(comm)
simpphoto <- diversity(comm, index = "simpson")
Sphoto <- specnumber(comm)
Jphoto <- Hphoto/log(Sphoto)
```



