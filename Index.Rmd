---
title: "Index (Cleaned up work)"
output: html_document
---
```{r setup, include=FALSE}
library(ggplot2)
library(tidyverse)
library(dplyr)
library(meta)
library(PRISMAstatement)
library(skimr)
library(MASS)
library(ggpubr) 
library(vegan)
library(emmeans)
setwd("/R Packages/Chapter 2")
```
###Hypothesis
Increasing shrub densities will result in increasing animal interactions, and may be influenced by the local microclimate.

###Predictions
a. Increasing shrub density from shrub-free locations to relatively higher densities positively predict animal community density;
b. Increasing shrub cover at varying densities positively predicts animal community densities; 
c. Response to shrub density are species specific by the animal population; 
d. Local microclimate will act as a stressor impacting animal interactions

###Wrangle
```{r}
data.final <- read.csv("data.csv")

density_simple <- data.final %>%
  group_by(as.character(density_levels), density_category, density, microsite, phylum) %>%
  summarise(animals = sum(daily_animal_totals), richness = n()) %>%
  rename(density_levels = 'as.character(density_levels)')

data_simple <- data.final %>%
  group_by(as.character(density_levels), method, density_category, density, microsite) %>%
  summarise(animals = sum(daily_animal_totals), richness = n()) %>%
  rename(density_levels = 'as.character(density_levels)')

density_simple2 <- data.final %>%
  group_by(as.character(density_levels), density_category, density, cover) %>%
  summarise(animals = sum(daily_animal_totals), richness = n()) %>%
  rename(density_levels = 'as.character(density_levels)')

density_simple3 <- data.final %>%
  group_by(as.character(density_levels), density_category, microsite, density) %>%
  summarise(animals = sum(daily_animal_totals), richness = n()) %>%
  rename(density_levels = 'as.character(density_levels)')
```
```{r}
#RDM Set up
RDM <- read.csv("RDM.CSV")
data_RDM <- RDM %>%
  group_by(as.character(density_level), Site.Density, density, RDM_g, microsite) %>%
  summarise() %>%
  rename(density_level = 'as.character(density_level)')

names(data_RDM)[1] <- "density_levels"
```
```{r}
climate <- read_csv("Carrizo_micronet.csv")
data_climate <- climate %>%
  group_by(as.character(density_level), microsite, temp) %>%
  summarise() %>%
  rename(density_level = 'as.character(density_level)')
names(data_climate)[1] <- "density_levels"

density_simple4 <- data.final %>%
  group_by(as.character(density_levels), microsite) %>%
  summarise(animals = sum(daily_animal_totals), richness = n()) %>%
  rename(density_levels = 'as.character(density_levels)')

animal.climate.data <- merge(data_climate, density_simple4, all = TRUE)
```
```{r}
density_simple5 <- data.final %>%
  group_by(as.character(density_levels), plot, density, microsite, phylum) %>%
  summarise(animals = sum(daily_animal_totals), richness = n()) %>%
  rename(density_levels = 'as.character(density_levels)')

data_RDM2 <- RDM %>%
  group_by(as.character(density_level), density, microsite) %>%
  summarise(RDM = mean(RDM_g)) %>%
  rename(density_level = 'as.character(density_level)')
names(data_RDM2)[1] <- "density_levels"

data_climate2 <- climate %>%
  group_by(as.character(density_level), microsite) %>%
  summarise(mean_temp = mean(temp), max_temp = max(temp)) %>%
  rename(density_level = 'as.character(density_level)')
names(data_climate2)[1] <- "density_levels"

rdm.climate <- merge(data_climate2, data_RDM2, all = TRUE)
final.data <- merge(density_simple5, rdm.climate, all = TRUE)

final.data$sd.animals <- sd(density_simple$animals, na.rm = TRUE)
final.data$sd.richness <- sd(density_simple$richness, na.rm = TRUE)

standarderroranimal <- sd(final.data$animals)/sqrt(length(final.data$animals))
final.data$se_animal <- standarderroranimal
standard_error_richness <- sd(final.data$richness)/sqrt(length(final.data$richness))
final.data$se_richness <- standard_error_richness

animal.data <- read.csv("animals.csv")
animal.data.final <- animal.data %>%
  group_by(as.character(species)) %>%
  summarise(number_of_animals = sum(daily_animal_totals)) %>%
  rename(species = "as.character(species)")

RDM <- read.csv("RDM.CSV")
data_RDM <- RDM %>%
  group_by(as.character(density_level), Site.Density, density, RDM_g, microsite) %>%
  summarise() %>%
  rename(density_level = 'as.character(density_level)')

names(data_RDM)[1] <- "density_levels"
animal.RDM.data <- merge(density_simple3, data_RDM, all = TRUE)

climate <- read_csv("Carrizo_micronet.csv")
data_climate <- climate %>%
  group_by(as.character(density_level), microsite, temp) %>%
  summarise() %>%
  rename(density_level = 'as.character(density_level)')
names(data_climate)[1] <- "density_levels"

animal.climate.data <- merge(data_climate, density_simple4, all = TRUE)
```

```{r}
#Vegan Set-up for PCoA
library(vegan)
library(ape)
library(tidyverse)
library(tidyr)
library(dplyr)

data <- read_csv("animals_revised.csv")

#summarize to site/plot/sample unit per row as observation
data <- read_csv("animals_revised.csv") %>%
  group_by(plot, microsite, phylum, species) %>%
  summarise(abundance = sum(daily_animal_totals)) %>%
  na.omit()

#turn into species matrix only
#split species into meaninful groups if needed such as native/exotic, vert/invert, functional roles
vert_species <- data %>%
  filter(phylum == "vertebrate") %>%
  spread(species,abundance) %>%
  ungroup() %>% 
  dplyr::select(-plot, -microsite, -phylum) %>% 
  replace(is.na(.), 0)
dim(vert_species)
env <- read_csv("environment.csv")
dim(env)

##PCA set up for Inverts
data <- read_csv("animals_revised.csv") %>%
  group_by(plot, microsite, phylum, species) %>%
  summarise(abundance = sum(daily_animal_totals)) %>%
  na.omit()
invert_species <- data %>%
  filter(phylum == "invertebrate") %>%
  spread(species, abundance) %>%
  ungroup() %>% 
  dplyr::select(-plot, -microsite, -phylum) %>% 
  replace(is.na(.), 0)
dim(invert_species)
env2 <- read_csv("environment.csv")
dim(env2)
```

```{r}
##Set up Simpson Data```{r}
density_simple6 <- data.final %>%
  group_by(as.character(density_levels), plot, density, phylum, daily_animal_totals, species, microsite) %>%
  summarise(animals = sum(daily_animal_totals), richness = n()) %>%
  rename(density_levels = 'as.character(density_levels)')
vegandata <- merge(density_simple6, rdm.climate, all = TRUE)

vegandata <- vegandata %>%
  group_by(density_levels, plot, density, microsite, daily_animal_totals, species, animals) %>%
  summarise(captures = sum(animals))

vegandata$density <- gsub(" ", "", vegandata$density)
vegandata$density <- as.factor(vegandata$density)
vegandata$uniID <- paste(vegandata$plot, vegandata$density)
str(vegandata)

library(dplyr)
vegandata <- vegandata %>% 
  ungroup()%>%
  dplyr::select(uniID, daily_animal_totals, captures)
vegandata <- vegandata %>% group_by(uniID, daily_animal_totals) %>% summarise(captures = sum(captures))

commvegan <- vegandata %>% spread(daily_animal_totals, captures)
commvegan[is.na(commvegan)] <- 0

commvegan <- commvegan %>%
  ungroup() %>%
  dplyr::select(-uniID)

sitefinal <- read_csv("site desntiy shortcut.csv")

sitefinal <- sitefinal %>%
  group_by(Site, plot, site.density, shrub.count)

sitefinal$shrub.count <- gsub(" ", "", sitefinal$shrub.count)
sitefinal$shrub.count <- as.factor(sitefinal$shrub.count)
sitefinal$uniID <- paste(sitefinal$site.density, sitefinal$site.count)
str(sitefinal)

sitefinal <- sitefinal %>%
  ungroup() %>%
  dplyr::select(uniID, plot, site.density, shrub.count)
sitefinal <- sitefinal %>% group_by(uniID, site.density)

sitefinal <- sitefinal %>%
  ungroup() %>%
  dplyr::select(-uniID)

names(sitefinal)[3] <- "density"

simpsonfinal <- diversity(commvegan, index = "simpson")
Hfinal <- diversity(commvegan)
Sfinal <- specnumber(commvegan)
Evenness <- Hfinal/log(Sfinal)
sitefinal$Simpson <- simpsonfinal
sitefinal$Evenness <- Evenness

final.data <- merge(final.data, sitefinal)

final.data$sd.simpson <- sd(final.data$Simpson, na.rm = TRUE)

standarderrorsimpson <- sd(final.data$Simpson)/sqrt(length(final.data$Simpson))
final.data$se_simpson <- standarderrorsimpson

standarderrorEvenness <- sd(final.data$Evenness)/sqrt(length(final.data$Evenness))
final.data$se_Evenness <- standarderrorEvenness

density_simple7 <- data.final %>%
  group_by(as.character(density_levels), plot, density, cover) %>%
  summarise(animals = sum(daily_animal_totals), richness = n()) %>%
  rename(density_levels = 'as.character(density_levels)')%>%
  dplyr::select(-animals, -richness)

final.data <- merge(final.data, density_simple7)
```

###Data Viz
```{r}
##Shrub Density v Animal Density
ggplot(final.data, aes(density, animals, color = microsite)) +
  geom_point(size = -1) +
  facet_wrap(~phylum) +
  scale_x_continuous(breaks = c(0,2,4,6,8,10,12)) +
  scale_color_brewer(palette = "Set1") + theme_classic() +
  geom_smooth(method = lm, se = TRUE) + 
  labs(x = "shrub density", y = "animal density")
```
```{r}
##Shrub Density v Animal Richness
ggplot(final.data, aes(density, richness, color = microsite)) +
  geom_point(size = -1) +
  facet_wrap(~phylum) +
  scale_x_continuous(breaks = c(0,2,4,6,8,10,12)) +
  scale_color_brewer(palette = "Set1") + theme_classic() +
  geom_smooth(method = lm, se = TRUE) + 
  labs(x = "shrub density", y = "animal richness")
```
```{r}
##Simpson v Animal Density
ggplot(final.data, aes(density, Simpson, color = microsite)) +
  geom_point(size = -1) +
  facet_wrap(~phylum) +
  scale_color_brewer(palette = "Set1") + theme_classic() +
  geom_smooth(method = lm, se = TRUE) + 
  labs(x = "shrub density", y = "Simpsons Value")
```
```{r}
##Simpson v Animal Density
ggplot(final.data, aes(density, Evenness, color = microsite)) +
  geom_point(size = -1) +
  facet_wrap(~phylum) +
  scale_color_brewer(palette = "Set1") + theme_classic() +
  geom_smooth(method = lm, se = TRUE) + 
  labs(x = "shrub density", y = "Evenness")
```


```{r}
#Animal Abundance v Richness
ggplot(final.data, aes(animals, richness, color = microsite)) +
  geom_point(size = -1) +
  facet_wrap(~phylum) +
  scale_color_brewer(palette = "Set1") + theme_classic() +
  geom_smooth(method = lm, se = TRUE) + 
  labs(x = "Animal Density", y = "Animal Richness")
```


###Stats Analysis
```{r}
#Stats for animal abundance with density level by micorsite with RDM, mean temp and phylum as covariates
m13 <- glm(animals ~ density*microsite+phylum+RDM+mean_temp, family = "quasipoisson", data = final.data)
anova(m13, test = "Chisq")
e13 <- emmeans(m13, pairwise~microsite|phylum)
e13
#emmeans seems to not yield any data for this
```
```{r}
#Stats for Animal Richness by density level with RDM and mean temp as covariates
m14 <- glm(richness ~ density*microsite+phylum+RDM+mean_temp, family = "quasipoisson", data = final.data)
anova(m14, test = "Chisq")
e14 <- emmeans(m14, pairwise~microsite|phylum)
e14

```

```{r}
#Stat analysis for simpson
m17 <- glm(Simpson ~ density*microsite+phylum+RDM+mean_temp, family = "quasipoisson", data = final.data)
anova(m17, test = "Chisq")
e17 <- emmeans(m17, pairwise~microsite|phylum)
e17
```
```{r}
#Stat analysis for Evenness
m18 <- glm(Evenness ~ density*microsite+phylum+RDM+mean_temp, family = "quasipoisson", data = final.data)
anova(m18, test = "Chisq")
e18 <- emmeans(m18, pairwise~microsite|phylum)
e18
```
###Appendix Figures
```{r}
#Appendix A Map of Shrub Locations
site.4 <- read.csv("Site 4 Data Sheet.csv")
#Map for appendix
library(ggmap)
register_google(key="AIzaSyBurG6FR6I4uc_nRUr6TY118dCsnM0tsiE")
carrizo4 <- get_map(location = c(lon = -119.6287, lat = 35.11941), zoom = 19, maptype = "satellite")
carrizo4
site.wide.map <- ggmap(carrizo4)
site.wide.map <- site.wide.map +
  geom_point(data=site.4, aes(x=shrub.lng, y=shrub.lat, color = Site), alpha = 6/10, size =2, show.legend = FALSE) +
  labs(title = "Site Wide Species Observations", x = "longitude", y = "latitude")
site.wide.map
```
```{r}
site.3 <- read.csv("Site 3 Data Sheet.csv")
#Map for appendix
library(ggmap)
register_google(key="AIzaSyBpfKtYrkYVS3LEJSjV1cIHeYrxJPsPX4U")
carrizo3 <- get_map(location = c(lon = -119.67255, lat = 35.16180), zoom = 19, maptype = "satellite")
carrizo3
site.wide.map <- ggmap(carrizo3)
site.wide.map <- site.wide.map +
  geom_point(data=site.3, aes(x=shrub.lng, y=shrub.lat, color = Site), alpha = 6/10, size =2, show.legend = FALSE) +
  labs(title = "Site Wide Species Observations", x = "longitude", y = "latitude")
site.wide.map
```

```{r}
#Appendix C Environmental Data (RDM, Temp, Cover)
ggplot(final.data, aes(RDM, animals, color = microsite)) +
  geom_point(size = -1) +
  facet_wrap(~phylum) +
  scale_x_continuous(breaks = c(0,2,4,6,8,10,12)) +
  scale_color_brewer(palette = "Set1") + theme_classic() +
  geom_smooth(method = lm, se = TRUE) + 
  labs(x = "shrub density", y = "animal density")
```
```{r}
#Compares Temperatures with animal abundances for each microsite (Use of Appendix?)
ggplot(final.data, aes(max_temp, animals, color = microsite)) +
  geom_point(size = -1) +
  facet_wrap(~phylum) +
  scale_color_brewer(palette = "Set1") + theme_classic() +
  geom_smooth(method = lm, se = TRUE) + 
  labs(x = "Max Temperature", y = "animal density")
```
```{r}
ggplot(final.data, aes(cover, animals, color = microsite)) +
  geom_point(size = -1) +
  facet_wrap(~phylum) +
  scale_color_brewer(palette = "Set1") + theme_classic() +
  geom_smooth(method = lm, se = TRUE) + 
  labs(x = "Shrub Cover", y = "animal density")
```

```{r}
#Appendix D Species List
list(animal.data.final)
```
```{r}
#Appendix E Contrast of sampling methods
ggplot(data_simple, aes(density_levels, animals, color = method)) +
  geom_boxplot() +
  scale_color_brewer(palette = "Set1") +
  theme_classic() + 
  labs(x = "shrub density level", y = "animal abundance")
```

```{r}
##Appendix F
m01 <- adonis(vert_species ~ microsite*shrub_density, data = env)
m01
#PCA!!!
dist <- vegdist(vert_species,  method = "bray")

res <- pcoa(dist) #ape library function
p1 <- as.data.frame(res$vectors) %>% 
  dplyr::select(Axis.1, Axis.2) %>%
  bind_cols(env, .)
#PCOA Plots for Verts
ggplot(p1, aes(Axis.1, Axis.2, group = microsite)) +
  geom_point(aes(color = microsite)) +
  geom_text(aes(label=plot),hjust=0, vjust=0, check_overlap = TRUE, nudge_x = 0.01) +
  scale_color_brewer(palette = "Set1") +
  labs(color = "", subtitle = "labels denote plot identity")
ggplot(p1, aes(Axis.1, Axis.2, group = microsite)) +
  geom_point(aes(color = microsite)) +
  geom_text(aes(label=shrub_density),hjust=0, vjust=0, check_overlap = TRUE, nudge_x = 0.01) +
  scale_color_brewer(palette = "Set1") +
  labs(color = "", subtitle = "labels denote shrub density at each plot")
```
```{r}
m04 <- adonis(invert_species ~ microsite*shrub_density, data = env2)
m04
dist <- vegdist(invert_species,  method = "bray")
res <- pcoa(dist) #ape library function
p2 <- as.data.frame(res$vectors) %>% 
  dplyr::select(Axis.1, Axis.2) %>%
  bind_cols(env, .)
#label by site is ok
ggplot(p2, aes(Axis.1, Axis.2, group = microsite)) +
  geom_point(aes(color = microsite)) +
  geom_text(aes(label=plot),hjust=0, vjust=0, check_overlap = TRUE, nudge_x = 0.01) +
  scale_color_brewer(palette = "Set1") +
  labs(color = "", subtitle = "labels denote plot identity")
ggplot(p2, aes(Axis.1, Axis.2, group = microsite)) +
  geom_point(aes(color = microsite)) +
  geom_text(aes(label=shrub_density),hjust=0, vjust=0, check_overlap = TRUE, nudge_x = 0.01) +
  scale_color_brewer(palette = "Set1") +
  labs(color = "", subtitle = "labels denote shrub density at each plot")
```

```{r}
#PCOA Stats
m02 <- betadisper(dist, env$microsite)
m02
anova(m02)
permutest(m02, pairwise = TRUE, permutations = 99)
m2.HSD <- TukeyHSD(m02)
boxplot(m02)
m03 <- betadisper(dist, env$shrub_density)
m03
anova(m03)
permutest(m03, pairwise = TRUE, permutations = 99)
m03.HSD <- TukeyHSD(m03)
boxplot(m03)
```